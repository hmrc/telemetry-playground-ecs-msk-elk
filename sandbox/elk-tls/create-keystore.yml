version: '2.2'

services:
  create_keystore:
    image: docker.elastic.co/elasticsearch/elasticsearch:${VERSION}
    container_name: create_keystore
    command: >
      bash -c "
        yum install -y -q -e 0 openssl;
        ./bin/elasticsearch-keystore create
        KEY_PASSPHRASE=$$(cat passphrase)
        for KEY in xpack.security.http.ssl.keystore.secure_password \
                   xpack.security.http.ssl.keystore.secure_key_password \
                   xpack.security.http.ssl.truststore.secure_password \
                   xpack.security.transport.ssl.keystore.secure_password \
                   xpack.security.transport.ssl.keystore.secure_key_password \
                   xpack.security.transport.ssl.truststore.secure_password; do
        	echo $${KEY_PASSPHRASE} | ./bin/elasticsearch-keystore add $${KEY}
        done
        ./bin/elasticsearch-keystore list
        cp ca.crt keystore.p12 truststore.p12 /certs
        cp ./config/elasticsearch.keystore /keystore
        chown -R 1000:0 /certs
        chown -R 1000:0 /keystore
        ls -la /certs /keystore
      "
    working_dir: /usr/share/elasticsearch
    volumes:
      - ./passphrase:/usr/share/elasticsearch/passphrase
      - ./certs/ca.crt:/usr/share/elasticsearch/ca.crt
      - ./certs/keystore.p12:/usr/share/elasticsearch/keystore.p12
      - ./certs/truststore.p12:/usr/share/elasticsearch/truststore.p12
      - ./config-keystore:/usr/share/elasticsearch/config
      - certs:/certs
      - keystore:/keystore
    networks:
      - elastic

volumes:
  certs:
    driver: local
  keystore:
    driver: local

networks:
  elastic:
    driver: bridge
